import{aT as d,gJ as m,fo as p,J as o,M as h,fA as v,N as g,fu as y,dO as I,m as w}from"./index-BF2r6OBf.js";import{a as b}from"./layerContainerType-CSXZNpHb.js";const a=new d,i=new WeakMap;function $(e){D(e)&&a.push(new WeakRef(e))}function C(e){const s=a.find(r=>r.deref()===e);s&&a.remove(s)}function D(e){return e!=null&&typeof e=="object"&&"refreshInterval"in e&&"refresh"in e}function c(e,s){return Number.isFinite(e)&&Number.isFinite(s)?s<=0?e:c(s,e%s):0}let l=0,f=0;function T(){const e=Date.now();let s=!1;for(const r of a){const t=r.deref();t?t.refreshInterval&&e-(i.get(t)??0)+5>=6e4*t.refreshInterval&&(i.set(t,e),t.refresh(e)):s=!0}if(s)for(let r=a.length-1;r>=0;r--)a.at(r).deref()||a.removeAt(r)}m(()=>{const e=Date.now();let s=0;for(const r of a){const t=r.deref();t&&(s=c(Math.round(6e4*t.refreshInterval),s),t.refreshInterval?i.get(t)||i.set(t,e):i.delete(t))}if(s!==f){if(f=s,clearInterval(l),f===0)return void(l=0);l=setInterval(T,f)}},p);const u=.1,O=e=>{const s=e;let r=class extends s{constructor(...t){super(...t),this.refreshInterval=0,this.refreshTimestamp=0,this._debounceHasDataChanged=y(()=>this.hasDataChanged()),this.when().then(()=>{this.destroyed||$(this)},()=>{})}destroy(){C(this)}castRefreshInterval(t){return t>=u?t:t<=0?0:u}get refreshParameters(){return{_ts:this.refreshTimestamp||null}}refresh(t=Date.now()){I(this._debounceHasDataChanged()).then(n=>{n&&this._set("refreshTimestamp",t),this.emit("refresh",{dataChanged:n})},n=>{w.getLogger(this).error(n),this.emit("refresh",{dataChanged:!1,error:n})})}async hasDataChanged(){return!0}get test(){}};return o([h({type:Number,json:{write:!0,origins:{"web-scene":{write:{enabled:!0,layerContainerTypes:b}}}}})],r.prototype,"refreshInterval",void 0),o([v("refreshInterval")],r.prototype,"castRefreshInterval",null),o([h({readOnly:!0})],r.prototype,"refreshTimestamp",void 0),o([h({readOnly:!0})],r.prototype,"refreshParameters",null),r=o([g("esri.layers.mixins.RefreshableLayer")],r),r};export{O as f};
